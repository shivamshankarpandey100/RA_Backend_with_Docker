version: '3.8'

services:
  # ========================================
  # DATABASE SERVICES
  # ========================================

  # Auth Service Database
  postgres-auth:
    image: postgres:15-alpine
    container_name: postgres-auth
    environment:
      POSTGRES_DB: ${AUTH_DB_NAME:-auth_db}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-root}
    ports:
      - "5432:5432"
    volumes:
      - postgres-auth-data:/var/lib/postgresql/data
    networks:
      - reelapp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Catalog Service Database
  postgres-catalog:
    image: postgres:15-alpine
    container_name: postgres-catalog
    environment:
      POSTGRES_DB: ${CATALOG_DB_NAME:-newcatalog}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-root}
    ports:
      - "5433:5432"
    volumes:
      - postgres-catalog-data:/var/lib/postgresql/data
    networks:
      - reelapp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # User Service Database
  postgres-user:
    image: postgres:15-alpine
    container_name: postgres-user
    environment:
      POSTGRES_DB: ${USER_DB_NAME:-admin-userservice}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-root}
    ports:
      - "5434:5432"
    volumes:
      - postgres-user-data:/var/lib/postgresql/data
    networks:
      - reelapp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Video Ingestion Service Database
  postgres-video:
    image: postgres:15-alpine
    container_name: postgres-video
    environment:
      POSTGRES_DB: ${VIDEO_DB_NAME:-video_ingestion}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-root}
    ports:
      - "5435:5432"
    volumes:
      - postgres-video-data:/var/lib/postgresql/data
    networks:
      - reelapp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Permission Service Database
  postgres-permission:
    image: postgres:15-alpine
    container_name: postgres-permission
    environment:
      POSTGRES_DB: ${PERMISSION_DB_NAME:-permission_access}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-root}
    ports:
      - "5436:5432"
    volumes:
      - postgres-permission-data:/var/lib/postgresql/data
    networks:
      - reelapp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Video Playback Service Database
  postgres-playback:
    image: postgres:15-alpine
    container_name: postgres-playback
    environment:
      POSTGRES_DB: ${PLAYBACK_DB_NAME:-video_streaming}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-root}
    ports:
      - "5437:5432"
    volumes:
      - postgres-playback-data:/var/lib/postgresql/data
    networks:
      - reelapp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Subscription Service Database
  postgres-subscription:
    image: postgres:15-alpine
    container_name: postgres-subscription
    environment:
      POSTGRES_DB: ${SUBSCRIPTION_DB_NAME:-subscripption}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-root}
    ports:
      - "5438:5432"
    volumes:
      - postgres-subscription-data:/var/lib/postgresql/data
    networks:
      - reelapp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Transcoding Service Database
  postgres-transcoding:
    image: postgres:15-alpine
    container_name: postgres-transcoding
    environment:
      POSTGRES_DB: ${TRANSCODING_DB_NAME:-transcoding}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-root}
    ports:
      - "5439:5432"
    volumes:
      - postgres-transcoding-data:/var/lib/postgresql/data
    networks:
      - reelapp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ========================================
  # MICROSERVICES
  # ========================================

  # Auth Service (First entry point for authentication)
  auth-service:
    build:
      context: ./RA_AuthService
      dockerfile: Dockerfile
    container_name: auth-service
    ports:
      - "${AUTH_PORT:-8080}:8080"
    environment:
      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-auth:5432/${AUTH_DB_NAME:-auth_db}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-root}

      # JWT Configuration
      JWT_SECRET: ${JWT_SECRET:-afkjh3r9238hf92h3f983hf9283hf9823h9f82h3f9823hf9283hf9823h9f82h3f9823h620ra120hul4954}

      # JPA Configuration
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL:-false}

      # Server Configuration
      SERVER_PORT: 8080
    depends_on:
      postgres-auth:
        condition: service_healthy
    networks:
      - reelapp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

  # Permission Service (IAM - Role-based access control)
  permission-service:
    build:
      context: ./RA_Permission
      dockerfile: Dockerfile
    container_name: permission-service
    ports:
      - "${PERMISSION_PORT:-8085}:8085"
    environment:
      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-permission:5432/${PERMISSION_DB_NAME:-permission_access}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-root}

      # JPA Configuration
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL:-false}

      # Server Configuration
      SERVER_PORT: 8085
    depends_on:
      postgres-permission:
        condition: service_healthy
    networks:
      - reelapp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # API Gateway (Central entry point for all requests)
  api-gateway:
    build:
      context: ./api_gateway
      dockerfile: Dockerfile
    container_name: api_gateway
    ports:
      - "${GATEWAY_PORT:-3000}:3000"
    environment:
      # JWT Configuration (must match auth-service)
      JWT_SECRET: ${JWT_SECRET:-afkjh3r9238hf92h3f983hf9283hf9823h9f82h3f9823hf9283hf9823h9f82h3f9823h620ra120hul4954}

      # Service URLs for routing
      AUTH_SERVICE_URL: http://auth-service:8080
      CATALOG_SERVICE_URL: http://catalog-service:8081
      USER_SERVICE_URL: http://user-service:8089
      VIDEO_SERVICE_URL: http://video-service:8087
      PERMISSION_SERVICE_URL: http://permission-service:8085
      SUBSCRIPTION_SERVICE_URL: http://subscription-service:8086
      TRANSCODING_SERVICE_URL: http://transcoding-service:8090

      # Server Configuration
      SERVER_PORT: 3000
    depends_on:
      auth-service:
        condition: service_healthy
      permission-service:
        condition: service_healthy
    networks:
      - reelapp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Catalog Service
  catalog-service:
    build:
      context: ./RA_CatalogService
      dockerfile: Dockerfile
    container_name: catalog-service
    ports:
      - "${CATALOG_PORT:-8081}:8081"
    environment:
      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-catalog:5432/${CATALOG_DB_NAME:-newcatalog}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-root}

      # JPA Configuration
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL:-false}

      # Server Configuration
      SERVER_PORT: 8081
    depends_on:
      postgres-catalog:
        condition: service_healthy
    networks:
      - reelapp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # User Service
  user-service:
    build:
      context: ./RA_userService
      dockerfile: Dockerfile
    container_name: user-service
    ports:
      - "${USER_PORT:-8089}:8089"
    environment:
      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-user:5432/${USER_DB_NAME:-admin-userservice}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-root}

      # JPA Configuration
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL:-false}

      # Server Configuration
      SERVER_PORT: 8089
    depends_on:
      postgres-user:
        condition: service_healthy
    networks:
      - reelapp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8089/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Video Ingestion Service
  video-service:
    build:
      context: ./RA_VideoIngestionService/videoIngestion
      dockerfile: Dockerfile
    container_name: video-service
    ports:
      - "${VIDEO_PORT:-8087}:8087"
    environment:
      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-video:5432/${VIDEO_DB_NAME:-video_ingestion}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-root}

      # JPA Configuration
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL:-false}

      # File Upload Configuration
      SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE: 2GB
      SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE: 2GB

      # Server Configuration
      SERVER_PORT: 8087
    depends_on:
      postgres-video:
        condition: service_healthy
    volumes:
      - video-storage:/app/storage
    networks:
      - reelapp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8087/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Video Playback Service (Integrates with Catalog Service)
  playback-service:
    build:
      context: ./video-playback-service-final
      dockerfile: Dockerfile
    container_name: playback-service
    ports:
      - "${PLAYBACK_PORT:-8082}:8082"
    environment:
      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-playback:5432/${PLAYBACK_DB_NAME:-video_streaming}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-root}

      # JPA Configuration
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL:-false}

      # Catalog Service Integration
      CATALOG_SERVICE_URL: http://catalog-service:8081

      # Video Storage Path
      VIDEO_STORAGE_PATH: /app/videos

      # Server Configuration
      SERVER_PORT: 8082
    depends_on:
      postgres-playback:
        condition: service_healthy
      catalog-service:
        condition: service_healthy
    volumes:
      - playback-video-storage:/app/videos
    networks:
      - reelapp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Subscription Service
  subscription-service:
    build:
      context: ./Saanvitechs-RA_subscriptionAPI
      dockerfile: Dockerfile
    container_name: subscription-service
    ports:
      - "${SUBSCRIPTION_PORT:-8086}:8086"
    environment:
      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-subscription:5432/${SUBSCRIPTION_DB_NAME:-subscripption}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-root}

      # JPA Configuration
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL:-false}

      # Server Configuration
      SERVER_PORT: 8086
    depends_on:
      postgres-subscription:
        condition: service_healthy
    networks:
      - reelapp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8086/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Transcoding Service
  transcoding-service:
    build:
      context: ./RA_Transcoding
      dockerfile: Dockerfile
    container_name: transcoding-service
    ports:
      - "${TRANSCODING_PORT:-8090}:8090"
    environment:
      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-transcoding:5432/${TRANSCODING_DB_NAME:-transcoding}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-root}

      # JPA Configuration
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL:-false}

      # File Upload Configuration
      SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE: 10GB
      SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE: 10GB

      # Video Storage Path
      VIDEO_STORAGE_PATH: /app/transcoded

      # Server Configuration
      SERVER_PORT: 8090
    depends_on:
      postgres-transcoding:
        condition: service_healthy
    volumes:
      - transcoding-video-storage:/app/transcoded
    networks:
      - reelapp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8090/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# ========================================
# NETWORKS
# ========================================
networks:
  reelapp-network:
    driver: bridge
    name: reelapp-network

# ========================================
# VOLUMES
# ========================================
volumes:
  postgres-auth-data:
    name: reelapp-postgres-auth-data
  postgres-catalog-data:
    name: reelapp-postgres-catalog-data
  postgres-user-data:
    name: reelapp-postgres-user-data
  postgres-video-data:
    name: reelapp-postgres-video-data
  postgres-permission-data:
    name: reelapp-postgres-permission-data
  postgres-playback-data:
    name: reelapp-postgres-playback-data
  postgres-subscription-data:
    name: reelapp-postgres-subscription-data
  postgres-transcoding-data:
    name: reelapp-postgres-transcoding-data
  video-storage:
    name: reelapp-video-storage
  playback-video-storage:
    name: reelapp-playback-video-storage
  transcoding-video-storage:
    name: reelapp-transcoding-video-storage
